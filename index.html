<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service and Operations Dashboard | ServingIntel</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">

    <!-- MSAL via CDN ‚Äî no npm needed -->
    <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>

    <style>
        :root {
            --bg-primary: #0d0f14;
            --bg-card: #161922;
            --bg-card-hover: #1c2030;
            --accent-orange: #e8922a;
            --accent-orange-glow: rgba(232, 146, 42, 0.25);
            --accent-blue: #4a9eff;
            --accent-yellow: #f5a623;
            --accent-purple: #b07dd6;
            --text-primary: #f0f0f0;
            --text-secondary: #8b8fa3;
            --text-muted: #5a5e72;
            --border: rgba(255,255,255,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-glow {
            position: fixed;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
        }
        .bg-glow.orange { background: var(--accent-orange); top: -100px; right: -100px; }
        .bg-glow.blue { background: var(--accent-blue); bottom: -100px; left: -100px; opacity: 0.08; }

        /* HEADER */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(13, 15, 20, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-group { display: flex; align-items: center; gap: 10px; }

        .logo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--accent-orange), #d47a15);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 800; font-size: 18px; color: white; flex-shrink: 0;
        }

        .logo-text { display: flex; flex-direction: column; line-height: 1.15; }
        .logo-text .title { font-weight: 700; font-size: 13px; color: var(--text-primary); }
        .logo-text .subtitle { font-size: 9px; font-weight: 500; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); }

        .btn-sign-in {
            background: linear-gradient(135deg, var(--accent-orange), #d47a15);
            color: white; border: none; padding: 10px 20px; border-radius: 10px;
            font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 14px;
            cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-sign-in:hover { transform: translateY(-1px); box-shadow: 0 6px 24px var(--accent-orange-glow); }
        .btn-sign-in svg { width: 16px; height: 16px; }

        .user-menu { display: flex; align-items: center; gap: 10px; }
        .user-avatar {
            width: 32px; height: 32px; border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-orange), #d47a15);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 12px; color: white;
            overflow: hidden;
        }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-name { font-weight: 600; font-size: 13px; color: var(--text-primary); }
        .btn-sign-out {
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-secondary); padding: 8px 14px; border-radius: 8px;
            font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 12px;
            cursor: pointer; transition: all 0.2s ease;
        }
        .btn-sign-out:hover { background: rgba(232,90,90,0.1); border-color: rgba(232,90,90,0.3); color: #e85a5a; }

        main { position: relative; z-index: 1; padding: 0 20px; }

        /* LANDING PAGE */
        /* Logo silhouette background */
        .hero {
            padding: 48px 0 36px;
            text-align: center;
            position: relative;
        }
        .hero-silhouette {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 380px;
            height: 380px;
            opacity: 0.06;
            pointer-events: none;
            z-index: -1;
            object-fit: contain;
        }
        @media (max-width: 640px) {
            .hero-silhouette {
                width: 280px;
                height: 280px;
            }
        }
        .hero h1 {
            font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 800;
            font-size: clamp(32px, 8vw, 56px); line-height: 1.05; margin-bottom: 16px;
        }
        .hero h1 .highlight {
            background: linear-gradient(135deg, var(--accent-orange), #f5c842);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .hero p { color: var(--text-secondary); font-size: 15px; line-height: 1.6; max-width: 380px; margin: 0 auto 28px; }

        .hero-cta { display: none; }
        @media (max-width: 640px) {
            .hero-cta { display: flex; justify-content: center; margin-bottom: 32px; }
            .hero-cta .btn-sign-in { padding: 14px 32px; font-size: 16px; border-radius: 14px; box-shadow: 0 4px 20px var(--accent-orange-glow); }
        }

        .tier-grid { display: flex; flex-direction: column; gap: 12px; max-width: 480px; margin: 0 auto 40px; }
        .tier-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
            padding: 16px 18px; display: flex; align-items: center; gap: 14px; transition: all 0.3s ease;
        }
        .tier-card:hover { background: var(--bg-card-hover); border-color: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .tier-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .tier-dot.dynamics { background: var(--accent-orange); }
        .tier-dot.t1 { background: var(--accent-blue); }
        .tier-dot.t2 { background: var(--accent-yellow); }
        .tier-dot.t3 { background: var(--accent-purple); }
        .tier-info { display: flex; flex-direction: column; }
        .tier-info .tier-name { font-weight: 700; font-size: 14px; }
        .tier-info .tier-desc { font-size: 12px; color: var(--text-secondary); }
        .tier-badge { margin-left: auto; font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; padding: 4px 10px; border-radius: 6px; background: rgba(255,255,255,0.04); color: var(--text-muted); }

        .features { max-width: 480px; margin: 0 auto 48px; }
        .features-label { font-size: 10px; font-weight: 600; letter-spacing: 2.5px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 16px; text-align: center; }
        .features-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .feature-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center; }
        .feature-item .feat-icon { font-size: 22px; margin-bottom: 8px; }
        .feature-item .feat-text { font-size: 12px; font-weight: 600; color: var(--text-secondary); line-height: 1.4; }

        /* DASHBOARD PAGE */
        #dashboard-page { display: none; padding: 32px 0; max-width: 680px; margin: 0 auto; }
        .welcome-banner {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; padding: 28px 24px; margin-bottom: 20px; text-align: center;
        }
        .welcome-banner h2 { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 800; font-size: 22px; margin-bottom: 6px; }
        .welcome-banner p { color: var(--text-secondary); font-size: 14px; }
        .dashboard-placeholder { color: var(--text-muted); font-size: 13px; text-align: center; padding: 40px 0; }

        footer { text-align: center; padding: 24px 20px 32px; border-top: 1px solid var(--border); }
        footer p { font-size: 11px; color: var(--text-muted); }

        @media (min-width: 768px) {
            header { padding: 14px 32px; }
            main { padding: 0 32px; }
            .hero { padding: 72px 0 48px; }
            .hero p { font-size: 17px; max-width: 500px; }
            .tier-grid { flex-direction: row; flex-wrap: wrap; max-width: 680px; gap: 14px; }
            .tier-card { flex: 1 1 calc(50% - 7px); min-width: 280px; }
            .features-grid { grid-template-columns: repeat(4, 1fr); max-width: 680px; margin: 0 auto; }
            .features { max-width: 680px; }
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hero h1 { animation: fadeUp 0.6s ease forwards; }
        .hero p { animation: fadeUp 0.6s ease 0.1s forwards; opacity: 0; }
        .hero-cta { animation: fadeUp 0.6s ease 0.15s forwards; opacity: 0; }
        .tier-card:nth-child(1) { animation: fadeUp 0.5s ease 0.2s forwards; opacity: 0; }
        .tier-card:nth-child(2) { animation: fadeUp 0.5s ease 0.28s forwards; opacity: 0; }
        .tier-card:nth-child(3) { animation: fadeUp 0.5s ease 0.36s forwards; opacity: 0; }
        .tier-card:nth-child(4) { animation: fadeUp 0.5s ease 0.44s forwards; opacity: 0; }
        .feature-item { animation: fadeUp 0.4s ease 0.5s forwards; opacity: 0; }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 4px 20px var(--accent-orange-glow); }
            50% { box-shadow: 0 4px 32px rgba(232, 146, 42, 0.4); }
        }
        @media (max-width: 640px) {
            .hero-cta .btn-sign-in { animation: fadeUp 0.6s ease 0.15s forwards, pulse-glow 2.5s ease-in-out 1s infinite; opacity: 0; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="bg-glow orange"></div>
    <div class="bg-glow blue"></div>

    <header>
        <div class="logo-group">
            <div class="logo-icon">S</div>
            <div class="logo-text">
                <span class="title">Service and Operations Dashboard</span>
                <span class="subtitle">Performance Analytics</span>
            </div>
        </div>

        <!-- Logged out: Sign In button -->
        <button id="header-sign-in" class="btn-sign-in" onclick="signIn()">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
            </svg>
            Sign In
        </button>

        <!-- Logged in: User menu -->
        <div id="header-user-menu" class="user-menu hidden">
            <div class="user-avatar" id="user-avatar">??</div>
            <span class="user-name" id="user-name"></span>
            <button class="btn-sign-out" onclick="signOut()">Sign Out</button>
        </div>
    </header>

    <main>
        <!-- LANDING PAGE -->
        <div id="landing-page">
            <section class="hero">
                <img class="hero-silhouette" src="./logo_bg.png" onerror="this.src='./public/logo_bg.png'" alt="">
                <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:28px;">
                    <div style="width:64px;height:64px;background:linear-gradient(135deg,var(--accent-orange),#d47a15);border-radius:16px;display:flex;align-items:center;justify-content:center;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:32px;color:white;margin-bottom:14px;box-shadow:0 8px 32px var(--accent-orange-glow);">S</div>
                    <div style="font-weight:700;font-size:18px;color:var(--text-primary);line-height:1.3;text-align:center;">Service and Operations<br>Dashboard</div>
                    <div style="font-size:10px;font-weight:600;letter-spacing:2.5px;text-transform:uppercase;color:var(--text-muted);margin-top:6px;">Performance Analytics</div>
                </div>
                <h1>Real-time SLA<br><span class="highlight">Intelligence</span></h1>
                <p>Monitor your Service Desk, Programming Team, and Relationship Managers. Powered by Dynamics 365.</p>
                <div class="hero-cta">
                    <button class="btn-sign-in" onclick="signIn()">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                        </svg>
                        Sign In with Microsoft
                    </button>
                </div>
            </section>

            <div class="tier-grid">
                <div class="tier-card">
                    <div class="tier-dot dynamics"></div>
                    <div class="tier-info"><span class="tier-name">Dynamics 365</span><span class="tier-desc">Live data integration</span></div>
                    <span class="tier-badge">Source</span>
                </div>
                <div class="tier-card">
                    <div class="tier-dot t1"></div>
                    <div class="tier-info"><span class="tier-name">Tier 1 Service Desk</span><span class="tier-desc">First response &amp; triage</span></div>
                    <span class="tier-badge">SLA</span>
                </div>
                <div class="tier-card">
                    <div class="tier-dot t2"></div>
                    <div class="tier-info"><span class="tier-name">Tier 2 Programming</span><span class="tier-desc">Escalations &amp; dev</span></div>
                    <span class="tier-badge">SLA</span>
                </div>
                <div class="tier-card">
                    <div class="tier-dot t3"></div>
                    <div class="tier-info"><span class="tier-name">Tier 3 Rel. Managers</span><span class="tier-desc">Client operations</span></div>
                    <span class="tier-badge">SLA</span>
                </div>
            </div>

            <section class="features">
                <div class="features-label">What you get</div>
                <div class="features-grid">
                    <div class="feature-item"><div class="feat-icon">üìä</div><div class="feat-text">Real-time KPIs</div></div>
                    <div class="feature-item"><div class="feat-icon">‚è±Ô∏è</div><div class="feat-text">Avg Resolution Time</div></div>
                    <div class="feature-item"><div class="feat-icon">üìû</div><div class="feat-text">8x8 Call Metrics</div></div>
                    <div class="feature-item"><div class="feat-icon">üîí</div><div class="feat-text">Azure AD Auth</div></div>
                </div>
            </section>
        </div>

        <!-- DASHBOARD (after login) -->
        <div id="dashboard-page">
            <div class="welcome-banner">
                <h2 id="welcome-text">Welcome back!</h2>
                <p>You're signed in. Your dashboard is loading...</p>
            </div>
            <div class="dashboard-placeholder">
                Your SLA dashboard components load here.
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2026 ServingIntel &middot; Service and Operations Dashboard</p>
    </footer>

    <script>
    // =============================================
    // üîê CONFIG ‚Äî ONLY EDIT THESE 2 VALUES
    // =============================================
    const CLIENT_ID = "3df6c0f7-b009-47a3-87f2-82172d866bdf";
    const TENANT_ID = "1b0086bd-aeda-4c74-a15a-23adfe4d0693";
    // =============================================
    // That's it. Everything else works automatically.
    // =============================================

    const msalConfig = {
        auth: {
            clientId: CLIENT_ID,
            authority: "https://login.microsoftonline.com/" + TENANT_ID,
            redirectUri: window.location.origin + window.location.pathname,
            postLogoutRedirectUri: window.location.origin + window.location.pathname,
        },
        cache: {
            cacheLocation: "sessionStorage",
            storeAuthStateInCookie: false,
        },
    };

    const loginRequest = { scopes: ["User.Read"] };

    // Initialize MSAL
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    let msalReady = false;

    msalInstance.initialize().then(() => {
        msalReady = true;
        console.log("MSAL initialized successfully");
        // Handle redirect response (mobile fallback)
        msalInstance.handleRedirectPromise().then((response) => {
            if (response) {
                msalInstance.setActiveAccount(response.account);
                onLoginSuccess(response.account);
            } else {
                // Already logged in? (page refresh / session still active)
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    msalInstance.setActiveAccount(accounts[0]);
                    onLoginSuccess(accounts[0]);
                }
            }
        }).catch((err) => console.error("Redirect error:", err));
    }).catch((err) => {
        console.error("MSAL init error:", err);
        alert("MSAL init failed: " + err.message);
    });

    // ‚îÄ‚îÄ‚îÄ Sign In ‚îÄ‚îÄ‚îÄ
    async function signIn() {
        if (!msalReady) {
            alert("Still loading, please wait a moment and try again.");
            return;
        }
        try {
            const response = await msalInstance.loginPopup(loginRequest);
            msalInstance.setActiveAccount(response.account);
            onLoginSuccess(response.account);
        } catch (error) {
            if (error.errorCode === "popup_window_error" || error.errorCode === "empty_window_error") {
                console.log("Popup blocked, falling back to redirect...");
                try {
                    await msalInstance.loginRedirect(loginRequest);
                } catch (redirectErr) {
                    alert("Redirect login error: " + redirectErr.message);
                }
            } else if (error.errorCode !== "user_cancelled") {
                console.error("Login error:", error);
                alert("Sign in error: " + error.message);
            }
        }
    }

    // ‚îÄ‚îÄ‚îÄ Sign Out ‚îÄ‚îÄ‚îÄ
    function signOut() {
        msalInstance.logoutPopup({
            postLogoutRedirectUri: window.location.origin + window.location.pathname,
            mainWindowRedirectUri: window.location.origin + window.location.pathname,
        }).catch(() => msalInstance.logoutRedirect());
    }

    // ‚îÄ‚îÄ‚îÄ On Login Success ‚Äî swap UI ‚îÄ‚îÄ‚îÄ
    function onLoginSuccess(account) {
        const name = account.name || account.username || "User";
        const initials = name.split(" ").map(n => n[0]).join("").toUpperCase().slice(0, 2);

        // Swap header buttons
        document.getElementById("header-sign-in").classList.add("hidden");
        document.getElementById("header-user-menu").classList.remove("hidden");
        document.getElementById("user-avatar").textContent = initials;
        document.getElementById("user-name").textContent = name;

        // Swap pages
        document.getElementById("landing-page").style.display = "none";
        document.getElementById("dashboard-page").style.display = "block";

        // Welcome
        const firstName = name.split(" ")[0];
        document.getElementById("welcome-text").textContent = "Welcome back, " + firstName + "! üëã";

        // Try to load profile photo
        loadProfilePhoto();
    }

    // ‚îÄ‚îÄ‚îÄ Load user photo from Microsoft Graph ‚îÄ‚îÄ‚îÄ
    async function loadProfilePhoto() {
        try {
            const token = await getAccessToken(["User.Read"]);
            const response = await fetch("https://graph.microsoft.com/v1.0/me/photo/$value", {
                headers: { Authorization: "Bearer " + token },
            });
            if (response.ok) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                document.getElementById("user-avatar").innerHTML = '<img src="' + url + '" alt="Profile">';
            }
        } catch (e) {
            // No photo ‚Äî initials are fine
        }
    }

    // ‚îÄ‚îÄ‚îÄ Get Access Token (for any API call) ‚îÄ‚îÄ‚îÄ
    // Usage:
    //   const token = await getAccessToken();
    //   fetch('https://yourorg.crm.dynamics.com/api/data/v9.2/incidents', {
    //       headers: { 'Authorization': 'Bearer ' + token }
    //   });
    async function getAccessToken(scopes) {
        const account = msalInstance.getActiveAccount();
        if (!account) throw new Error("Not signed in");

        try {
            const response = await msalInstance.acquireTokenSilent({
                scopes: scopes || loginRequest.scopes,
                account: account,
            });
            return response.accessToken;
        } catch (error) {
            // Token expired ‚Äî get new one via popup
            const response = await msalInstance.acquireTokenPopup({
                scopes: scopes || loginRequest.scopes,
            });
            return response.accessToken;
        }
    }
    </script>
</body>
</html>
